<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Morphlex Benchmark</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family:
					system-ui,
					-apple-system,
					sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				padding: 2rem;
				color: #1f2937;
			}

			.container {
				max-width: 900px;
				margin: 0 auto;
			}

			header {
				text-align: center;
				color: white;
				margin-bottom: 2rem;
			}

			h1 {
				font-size: 2.5rem;
				margin-bottom: 0.5rem;
				text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
			}

			.subtitle {
				font-size: 1.1rem;
				opacity: 0.9;
			}

			.card {
				background: white;
				border-radius: 12px;
				padding: 2rem;
				margin-bottom: 1.5rem;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
			}

			.controls {
				display: flex;
				gap: 1rem;
				flex-wrap: wrap;
				align-items: center;
				margin-bottom: 1.5rem;
			}

			label {
				font-weight: 600;
				display: flex;
				align-items: center;
				gap: 0.5rem;
			}

			input[type="number"],
			select {
				padding: 0.5rem;
				border: 2px solid #e5e7eb;
				border-radius: 6px;
				font-size: 1rem;
			}

			input[type="number"] {
				width: 100px;
			}

			select {
				min-width: 200px;
			}

			button {
				padding: 0.75rem 2rem;
				background: #6366f1;
				color: white;
				border: none;
				border-radius: 6px;
				font-size: 1rem;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.2s;
			}

			button:hover {
				background: #4f46e5;
				transform: translateY(-1px);
			}

			button:disabled {
				background: #9ca3af;
				cursor: not-allowed;
				transform: none;
			}

			.results {
				display: none;
			}

			.results.visible {
				display: block;
			}

			.result-item {
				padding: 1rem;
				border-bottom: 1px solid #e5e7eb;
			}

			.result-item:last-child {
				border-bottom: none;
			}

			.result-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 0.5rem;
			}

			.result-name {
				font-weight: 600;
				font-size: 1.1rem;
			}

			.result-time {
				font-size: 1.5rem;
				font-weight: 700;
				color: #6366f1;
			}

			.result-details {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
				gap: 1rem;
				margin-top: 0.75rem;
			}

			.detail {
				display: flex;
				flex-direction: column;
			}

			.detail-label {
				font-size: 0.75rem;
				color: #6b7280;
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}

			.detail-value {
				font-weight: 600;
				font-size: 1rem;
			}

			.progress {
				margin-top: 0.75rem;
				text-align: center;
				color: #6b7280;
				font-style: italic;
			}

			#sandbox {
				display: none;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<header>
				<h1>Morphlex Benchmark</h1>
				<p class="subtitle">Performance testing for DOM morphing</p>
			</header>

			<div class="card">
				<div class="controls">
					<label>
						Benchmark:
						<select id="benchmarkSelect">
							<option value="all">All Benchmarks</option>
						</select>
					</label>
					<label>
						Iterations:
						<input type="number" id="iterations" value="1000" min="100" step="100" />
					</label>
					<button id="runBtn">Run Benchmark</button>
				</div>
				<div class="progress" id="progress"></div>
			</div>

			<div class="card results" id="results">
				<h2 style="margin-bottom: 1.5rem">Results</h2>
				<div id="resultsContainer"></div>
			</div>
		</div>

		<div id="sandbox"></div>

		<script type="module">
			import { morph } from "../dist/morphlex.js"

			const testCases = [
				{
					name: "Simple Text Change",
					from: "<div>Hello</div>",
					to: "<div>World</div>",
				},
				{
					name: "Attribute Update",
					from: '<div class="foo" id="test">Content</div>',
					to: '<div class="bar" id="test">Content</div>',
				},
				{
					name: "Add Children",
					from: "<ul><li>One</li></ul>",
					to: "<ul><li>One</li><li>Two</li><li>Three</li></ul>",
				},
				{
					name: "Remove Children",
					from: "<ul><li>One</li><li>Two</li><li>Three</li></ul>",
					to: "<ul><li>One</li></ul>",
				},
				{
					name: "Reorder Children",
					from: '<ul><li id="a">A</li><li id="b">B</li><li id="c">C</li></ul>',
					to: '<ul><li id="c">C</li><li id="a">A</li><li id="b">B</li></ul>',
				},
				{
					name: "Deep Nested Update",
					from: "<div><div><div><span>Deep</span></div></div></div>",
					to: "<div><div><div><span>Nested</span></div></div></div>",
				},
				{
					name: "Large List (100 items)",
					from: "<ul>" + Array.from({ length: 100 }, (_, i) => `<li id="item-${i}">Item ${i}</li>`).join("") + "</ul>",
					to: "<ul>" + Array.from({ length: 100 }, (_, i) => `<li id="item-${i}">Item ${i * 2}</li>`).join("") + "</ul>",
				},
				{
					name: "Mixed Operations",
					from: '<div class="old"><p>Text</p><span id="keep">Keep</span></div>',
					to: '<div class="new"><span id="keep">Keep</span><p>New Text</p><a href="#">Link</a></div>',
				},
			]

			const sandbox = document.getElementById("sandbox")
			const runBtn = document.getElementById("runBtn")
			const benchmarkSelect = document.getElementById("benchmarkSelect")
			const iterationsInput = document.getElementById("iterations")
			const progressDiv = document.getElementById("progress")
			const resultsDiv = document.getElementById("results")
			const resultsContainer = document.getElementById("resultsContainer")

			// Populate benchmark select
			testCases.forEach((testCase, index) => {
				const option = document.createElement("option")
				option.value = index
				option.textContent = testCase.name
				benchmarkSelect.appendChild(option)
			})

			function createElements(html) {
				const temp = document.createElement("div")
				temp.innerHTML = html
				return temp.firstChild
			}

			async function runBenchmark(testCase, iterations) {
				const times = []

				for (let i = 0; i < iterations; i++) {
					const from = createElements(testCase.from)
					const to = createElements(testCase.to)
					sandbox.appendChild(from)

					const start = performance.now()
					morph(from, to)
					const end = performance.now()

					times.push(end - start)
					sandbox.innerHTML = ""

					// Yield to browser occasionally
					if (i % 100 === 0) {
						await new Promise((resolve) => setTimeout(resolve, 0))
					}
				}

				times.sort((a, b) => a - b)
				const total = times.reduce((sum, t) => sum + t, 0)
				const avg = total / times.length
				const median = times[Math.floor(times.length / 2)]
				const min = times[0]
				const max = times[times.length - 1]
				const p95 = times[Math.floor(times.length * 0.95)]

				return { total, avg, median, min, max, p95, times: times.length }
			}

			function displayResults(results) {
				resultsContainer.innerHTML = results
					.map(
						(result) => `
					<div class="result-item">
						<div class="result-header">
							<span class="result-name">${result.name}</span>
							<span class="result-time">${result.avg.toFixed(3)}ms</span>
						</div>
						<div class="result-details">
							<div class="detail">
								<span class="detail-label">Median</span>
								<span class="detail-value">${result.median.toFixed(3)}ms</span>
							</div>
							<div class="detail">
								<span class="detail-label">Min</span>
								<span class="detail-value">${result.min.toFixed(3)}ms</span>
							</div>
							<div class="detail">
								<span class="detail-label">Max</span>
								<span class="detail-value">${result.max.toFixed(3)}ms</span>
							</div>
							<div class="detail">
								<span class="detail-label">P95</span>
								<span class="detail-value">${result.p95.toFixed(3)}ms</span>
							</div>
							<div class="detail">
								<span class="detail-label">Total</span>
								<span class="detail-value">${result.total.toFixed(1)}ms</span>
							</div>
							<div class="detail">
								<span class="detail-label">Iterations</span>
								<span class="detail-value">${result.times}</span>
							</div>
						</div>
					</div>
				`,
					)
					.join("")

				resultsDiv.classList.add("visible")
			}

			runBtn.addEventListener("click", async () => {
				const iterations = parseInt(iterationsInput.value)
				if (iterations < 1) return

				const selectedValue = benchmarkSelect.value
				const selectedTests = selectedValue === "all" ? testCases : [testCases[parseInt(selectedValue)]]

				runBtn.disabled = true
				resultsDiv.classList.remove("visible")
				progressDiv.textContent = "Running benchmarks..."

				const results = []

				for (let i = 0; i < selectedTests.length; i++) {
					const testCase = selectedTests[i]
					progressDiv.textContent = `Running ${testCase.name} (${i + 1}/${selectedTests.length})...`

					const result = await runBenchmark(testCase, iterations)
					results.push({ name: testCase.name, ...result })

					await new Promise((resolve) => setTimeout(resolve, 100))
				}

				progressDiv.textContent = ""
				displayResults(results)
				runBtn.disabled = false
			})
		</script>
	</body>
</html>
